<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Data Kesehatan</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial;
      background: #f4f6f9;
      padding: 20px;
    }

    h2 { margin-bottom: 10px; }

    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      padding: 16px;
      border-radius: 10px;
      color: white;
      min-width: 200px;
    }

    .blue { background: #3b5bdb; }
    .purple { background: #7048e8; }
    .dark { background: #343a40; }
    .gray { background: #495057; }

    .white {
      background: white;
      color: black;
      padding: 16px;
      border-radius: 10px;
      flex: 1;
      min-width: 300px;
    }

    input, select, button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background: #3b5bdb;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Dashboard Data Kesehatan</h2>

<!-- FILTER -->
<div class="row">
  <div class="white">
    <b>Filter Laporan</b><br><br>
    <input type="month" id="bulanInput">
    <select id="rwInput">
      <option value="">SEMUA RW</option>
    </select>
    <button id="btnTampil">Tampilkan</button>
  </div>
</div>

<!-- CARD -->
<div class="row">
  <div class="card blue">
    <h1 id="jmlIbuHamil">0</h1>
    Jumlah Ibu Hamil
  </div>
  <div class="card purple">
    <h1 id="jmlBalita">0</h1>
    Jumlah Balita
  </div>
  <div class="card dark">
    <h1 id="jmlTB">0</h1>
    TB Terdeteksi
  </div>
  <div class="card gray">
    <h1 id="odfVal">0</h1>
    ODF
  </div>
</div>

<!-- GRAFIK -->
<div class="row">
  <div class="white">
    <h3>Ibu Hamil</h3>
    <canvas id="chartIbu"></canvas>
  </div>
  <div class="white">
    <h3>Balita</h3>
    <canvas id="chartBalita"></canvas>
  </div>
</div>

<div class="row">
  <div class="white">
    <h3>Lansia</h3>
    <canvas id="chartLansia"></canvas>
  </div>
</div>

<script type="module">
  import { db } from "./firebase.js";
  import {
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  let chartIbu, chartBalita, chartLansia;

  const bulanInput = document.getElementById("bulanInput");
  const rwInput = document.getElementById("rwInput");
  const btnTampil = document.getElementById("btnTampil");

  const chartIbuEl = document.getElementById("chartIbu");
  const chartBalitaEl = document.getElementById("chartBalita");
  const chartLansiaEl = document.getElementById("chartLansia");

  // default bulan sekarang
  bulanInput.value = new Date().toISOString().slice(0,7);

  // generate RW dropdown
  for (let i = 1; i <= 16; i++) {
    const opt = document.createElement("option");
    opt.value = `RW.${String(i).padStart(2, "0")}`;
    opt.textContent = opt.value;
    rwInput.appendChild(opt);
  }

  btnTampil.addEventListener("click", () => {
    loadDashboard(bulanInput.value, rwInput.value);
  });

  async function loadDashboard(bulan, rw) {
    try {
      let q;

      if (rw) {
        // üîπ 1 BULAN + 1 RW (1 DOKUMEN)
        q = query(
          collection(db, "kesehatan_agregat"),
          where("bulanLapor", "==", bulan),
          where("rw", "==", rw)
        );
      } else {
        // üîπ SEMUA RW DALAM 1 BULAN
        q = query(
          collection(db, "kesehatan_agregat"),
          where("bulanLapor", "==", bulan)
        );
      }

      const snap = await getDocs(q);

      if (snap.empty) {
        alert("‚ùå Data tidak ditemukan");
        resetDashboard();
        return;
      }

      let d = {
        ibuHamilNormal: 0,
        ibuHamilRisti: 0,
        balitaNormal: 0,
        balitaStunting: 0,
        balitaGiziBuruk: 0,
        tbTotal: 0,
        lansiaMandiri: 0,
        lansiaB: 0,
        lansiaC: 0,
        odf: 0
      };

      snap.forEach(doc => {
        const x = doc.data();
        d.ibuHamilNormal += x.ibuHamilNormal || 0;
        d.ibuHamilRisti += x.ibuHamilRisti || 0;
        d.balitaNormal += x.balitaNormal || 0;
        d.balitaStunting += x.balitaStunting || 0;
        d.balitaGiziBuruk += x.balitaGiziBuruk || 0;
        d.tbTotal += x.tbTotal || 0;
        d.lansiaMandiri += x.lansiaMandiri || 0;
        d.lansiaB += x.lansiaB || 0;
        d.lansiaC += x.lansiaC || 0;
        d.odf = Math.max(d.odf, x.odf || 0);
      });

      const ibuTotal = d.ibuHamilNormal + d.ibuHamilRisti;
      const balitaTotal = d.balitaNormal + d.balitaStunting + d.balitaGiziBuruk;

      jmlIbuHamil.innerText = ibuTotal;
      jmlBalita.innerText = balitaTotal;
      jmlTB.innerText = d.tbTotal;
      odfVal.innerText = d.odf;

      if (chartIbu) chartIbu.destroy();
      if (chartBalita) chartBalita.destroy();
      if (chartLansia) chartLansia.destroy();

      chartIbu = new Chart(chartIbuEl, {
        type: "pie",
        data: {
          labels: ["Normal", "Risiko Tinggi"],
          datasets: [{ data: [d.ibuHamilNormal, d.ibuHamilRisti] }]
        }
      });

      chartBalita = new Chart(chartBalitaEl, {
        type: "pie",
        data: {
          labels: ["Normal", "Stunting", "Gizi Buruk"],
          datasets: [{
            data: [d.balitaNormal, d.balitaStunting, d.balitaGiziBuruk]
          }]
        }
      });

      chartLansia = new Chart(chartLansiaEl, {
        type: "bar",
        data: {
          labels: ["Mandiri", "Kategori B", "Kategori C"],
          datasets: [{
            data: [d.lansiaMandiri, d.lansiaB, d.lansiaC]
          }]
        }
      });

    } catch (err) {
      console.error(err);
      alert("‚ùå Gagal memuat dashboard");
    }
  }

  function resetDashboard() {
    jmlIbuHamil.innerText = 0;
    jmlBalita.innerText = 0;
    jmlTB.innerText = 0;
    odfVal.innerText = 0;
  }

  // load awal
  loadDashboard(bulanInput.value, "");
</script>

</body>
</html>
