<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>UPTD PUSKESMAS CIKUTRA LAMA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px;color:#212529}
.row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.card{flex:1;min-width:220px;padding:16px;border-radius:12px;color:#fff}
.card h1{margin:0;font-size:26px}
.card span{font-size:13px;opacity:.9}
.green{background:#2f9e44}
.blue{background:#3b5bdb}
.teal{background:#0ca678}
.orange{background:#f59f00}
.dark{background:#343a40}
.gray{background:#495057}
.white{background:#fff;padding:16px;border-radius:12px;flex:1}
.chart-box{height:300px}
</style>
</head>

<body>

<h2>ðŸ“Š Dashboard Puskesmas Cikutra Lama</h2>

<div class="white">
<select id="rwInput"><option value="">SEMUA RW</option></select>
<input type="month" id="bulanInput">
<button id="btnTampil">Tampilkan</button>
</div>

<!-- ================= DATA WILAYAH ================= -->
<div class="row">
  <div class="card green"><h1 id="rtVal">0</h1><span>RT</span></div>
  <div class="card blue"><h1 id="pendudukVal">0</h1><span>Penduduk</span></div>
  <div class="card teal"><h1 id="jknVal">0</h1><span>JKN</span></div>
  <div class="card orange"><h1 id="mbgVal">0</h1><span>MBG</span></div>
</div>

<div class="row">
  <div class="card dark"><h1 id="sdVal">0</h1><span>SD</span></div>
  <div class="card gray"><h1 id="smpVal">0</h1><span>SMP</span></div>
  <div class="card green"><h1 id="smaVal">0</h1><span>SMA/SMK</span></div>
</div>

<!-- ================= KESEHATAN ================= -->
<div class="row">
  <div class="card dark"><h1 id="ibuHamilVal">0</h1><span>Ibu Hamil</span></div>
  <div class="card blue"><h1 id="balitaVal">0</h1><span>Balita</span></div>
  <div class="card gray"><h1 id="tbVal">0</h1><span>TB</span></div>
  <div class="card green"><h1 id="disVal">0</h1><span>Disabilitas</span></div>
</div>

<!-- ================= DIAGNOSA TOP 10 ================= -->
<div class="white">
<h3>Diagnosa Top 10</h3>
<ol id="diagnosaList"></ol>
</div>

<!-- ================= SANITASI ================= -->
<div class="row">
  <div class="card dark"><h1 id="tppJasaBoga">0</h1><span>Jasa Boga</span></div>
  <div class="card blue"><h1 id="tppRestoran">0</h1><span>Restoran</span></div>
  <div class="card gray"><h1 id="tppDamiu">0</h1><span>DAMIU</span></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { collection,getDocs,query,where } from
"https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const rwInput=document.getElementById("rwInput");
const bulanInput=document.getElementById("bulanInput");
bulanInput.value=new Date().toISOString().slice(0,7);

for(let i=1;i<=16;i++){
  rwInput.innerHTML+=`<option value="RW.${i}">RW ${i}</option>`;
}
btnTampil.onclick=loadAll;

async function loadProfil(){
  let q = rwInput.value
    ? query(collection(db,"profil_puskesmas"),
      where("bulanLapor","==",bulanInput.value),
      where("rw","==",rwInput.value))
    : query(collection(db,"profil_puskesmas"),
      where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);

  let rt=0,p=0,j=0,mbg=0,sd=0,smp=0,sma=0;
  let diag={};

  snap.forEach(d=>{
    const x=d.data();
    rt+=x.jumlahRT||0;
    p+=x.jumlahPenduduk||0;
    j+=x.jumlahJKN||0;
    mbg+=x.jumlahMBG||0;
    sd+=x.sekolahSD||0;
    smp+=x.sekolahSMP||0;
    sma+=x.sekolahSMA||0;

    (x.diagnosaTop10||[]).forEach(o=>{
      diag[o.nama]=(diag[o.nama]||0)+o.jumlah;
    });
  });

  rtVal.innerText=rt;
  pendudukVal.innerText=p;
  jknVal.innerText=j;
  mbgVal.innerText=mbg;
  sdVal.innerText=sd;
  smpVal.innerText=smp;
  smaVal.innerText=sma;

  const list=document.getElementById("diagnosaList");
  list.innerHTML="";
  Object.entries(diag)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10)
    .forEach(d=>{
      list.innerHTML+=`<li>${d[0]} : ${d[1]}</li>`;
    });
}

async function loadKesehatan(){
  let q = rwInput.value
    ? query(collection(db,"kesehatan_agregat"),
      where("bulanLapor","==",bulanInput.value),
      where("rw","==",rwInput.value))
    : query(collection(db,"kesehatan_agregat"),
      where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);
  let ih=0,b=0,tb=0,dis=0;

  snap.forEach(d=>{
    const x=d.data();
    ih+=(x.ibuHamilNormal||0)+(x.ibuHamilRisti||0);
    b+=(x.balitaNormal||0)+(x.balitaStunting||0)+(x.balitaGiziBuruk||0);
    tb+=x.tbTotal||0;
    dis+=x.disabilitas||0;
  });

  ibuHamilVal.innerText=ih;
  balitaVal.innerText=b;
  tbVal.innerText=tb;
  disVal.innerText=dis;
}

async function loadAll(){
  await loadProfil();
  await loadKesehatan();
}
loadAll();
</script>

</body>
</html>
