<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>UPTD PUSKESMAS CIKUTRA LAMA</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
font-family:Arial, sans-serif;
background:#f4f6f9;
padding:20px;
color:#212529;
}
small{color:#6c757d}

/* ===== HEADER (DIPERBESAR) ===== */
.header{
display:flex;
align-items:center;
gap:20px;
margin-bottom:24px;
padding:16px 20px;
background:#ffffff;
border-radius:14px;
box-shadow:0 4px 12px rgba(0,0,0,.06);
}

.header img{
width:180px;          /* ðŸ”¥ logo lebih besar */
height:auto;
}

.header h2{
margin:0;
font-size:38px;      /* ðŸ”¥ judul utama */
font-weight:700;
letter-spacing:.4px;
}

.header small{
display:block;
margin-top:4px;
font-size:20px;
color:#6c757d;
}

/* ===== LAYOUT ===== */
.row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}

.card{
flex:1;
padding:16px;
border-radius:12px;
color:#fff;
min-width:220px
}
.card h1{margin:0;font-size:26px}
.card span{font-size:13px;opacity:.9}

.green{background:#2f9e44}
.blue{background:#3b5bdb}
.teal{background:#0ca678}
.orange{background:#f59f00}
.purple{background:#7048e8}
.dark{background:#343a40}
.gray{background:#495057}

.white{
background:#fff;
padding:16px;
border-radius:12px;
flex:1;
min-width:300px
}

.chart-box{position:relative;width:100%;height:300px}

input,select,button{
padding:8px;
border-radius:6px;
border:1px solid #ccc
}
button{
background:#3b5bdb;
color:#fff;
border:none;
cursor:pointer
}

/* ===== PALET WARNA PROFESIONAL ===== */
.card-primary { background:#1c7ed6; }   /* biru utama */
.card-info    { background:#228be6; }   /* biru muda */
.card-success { background:#2f9e44; }   /* hijau */
.card-teal    { background:#0ca678; }   /* tosca */
.card-warning { background:#f59f00; }   /* oranye */
.card-danger  { background:#e03131; }   /* merah lembut */
.card-purple  { background:#7048e8; }   /* ungu */
.card-indigo  { background:#364fc7; }   /* indigo */
.card-slate   { background:#495057; }   /* abu gelap */
.card-muted   { background:#868e96; }   /* abu netral */

/* separator biar rapi */
.separator{
  width:100%;
  height:1px;
  background:#dee2e6;
  margin:24px 0;
}

/* ===== JUDUL HASIL AGREGAT ===== */
.aggregate-title{
  margin:28px 0 16px;
  padding:14px 18px;
  background:#ffffff;
  border-left:6px solid #1c7ed6;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}

.aggregate-title h3{
  margin:0;
  font-size:18px;
  font-weight:700;
  color:#212529;
}

.aggregate-title span{
  display:block;
  margin-top:4px;
  font-size:13px;
  color:#6c757d;
}
</style>
</head>

<body>

<!-- ===== HEADER LOGO ===== -->
<div class="header">
<img src="logo-puskesmas.png" alt="Logo Puskesmas">
<div>
<h2>UPTD PUSKESMAS CIKUTRA LAMA</h2>
<small>Dashboard Data Wilayah & Kesehatan</small>
</div>
</div>

<!-- ================= FILTER ================= -->
<div class="row">
<div class="white">
<b>Filter Data</b><br><br>
<select id="rwInput">
<option value="">SEMUA RW</option>
</select>
<input type="month" id="bulanInput">
<button id="btnTampil">Tampilkan</button>
</div>
</div>

<!-- ================= DATA WILAYAH ================= -->
<div class="aggregate-title">
  <h3>DATA WILAYAH</h3>
</div>
<div class="row">
  <div class="card card-primary"><h1 id="rtVal">0</h1><span>Jumlah RT</span></div>
  <div class="card card-info"><h1 id="pendudukVal">0</h1><span>Jumlah Penduduk</span></div>
  <div class="card card-teal"><h1 id="jknVal">0</h1><span>Peserta JKN</span></div>
  <div class="card card-warning"><h1 id="mbgVal">0</h1><span>Dapur MBG</span></div>
</div>

<div class="row">
  <div class="card card-indigo"><h1 id="tkVal">0</h1><span>TK / PAUD</span></div>
  <div class="card card-primary"><h1 id="sdVal">0</h1><span>Sekolah SD</span></div>
  <div class="card card-slate"><h1 id="smpVal">0</h1><span>Sekolah SMP</span></div>
  <div class="card card-muted"><h1 id="smaVal">0</h1><span>Sekolah SMA / SMK</span></div>
</div>

<div class="row">
  <div class="card card-indigo"><h1 id="ibadahVal">0</h1><span>Tempat Ibadah</span></div>
  <div class="card card-purple"><h1 id="ponpesVal">0</h1><span>Ponpes</span></div>
  <div class="card card-slate"><h1 id="hotelVal">0</h1><span>Hotel</span></div>
  <div class="card card-info"><h1 id="kantorVal">0</h1><span>Perkantoran</span></div>
</div>
<div class="separator"></div>

<!-- ================= KEHAMILAN ================= -->
<div class="aggregate-title">
  <h3>KEHAMILAN</h3>
</div>
<div class="row">
  <div class="card card-success"><h1 id="ihNormalVal">0</h1><span>Hamil Normal</span></div>
  <div class="card card-warning"><h1 id="ihRistiVal">0</h1><span>Hamil Risti</span></div>
  <div class="card card-danger"><h1 id="ihKekVal">0</h1><span>KEK</span></div>
</div>

<!-- ================= NIFAS ================= -->
<div class="aggregate-title">
  <h3>NIFAS</h3>
</div>
<div class="row">
  <div class="card card-success"><h1 id="inNormalVal">0</h1><span>Nifas Normal</span></div>
  <div class="card card-warning"><h1 id="inRistiVal">0</h1><span>Nifas Risti</span></div>
</div>

<!-- ================= BAYI ================= -->
<div class="aggregate-title">
  <h3>BAYI</h3>
</div>
<div class="row">
  <div class="card card-info"><h1 id="bayiTotalVal">0</h1><span>Total Bayi</span></div>
</div>

<!-- ================= BALITA ================= -->
<div class="aggregate-title">
  <h3>BALITA</h3>
</div>
<div class="row">
  <div class="card card-success"><h1 id="bNormalVal">0</h1><span>Normal</span></div>
  <div class="card card-warning"><h1 id="bStuntingVal">0</h1><span>Stunting</span></div>
  <div class="card card-danger"><h1 id="bGiziVal">0</h1><span>Gizi Buruk</span></div>
  <div class="card card-teal"><h1 id="bPMTVal">0</h1><span>Penerima PMT</span></div>
</div>
<div class="separator"></div>
  
<!-- ================= TB ================= -->
<div class="aggregate-title">
  <h3>TB</h3>
</div>
<div class="row">
  <div class="card card-warning"><h1 id="tbPengobatanVal">0</h1><span>Dalam Pengobatan</span></div>
  <div class="card card-success"><h1 id="tbSelesaiVal">0</h1><span>Selesai Pengobatan</span></div>
</div>

<!-- ================= DIAGNOSA ================= -->
<div class="aggregate-title">
  <h3>DIAGNOSA</h3>
</div>
<div class="row">
  <div class="card card-danger"><h1 id="dgHTVal">0</h1><span>Hipertensi</span></div>
  <div class="card card-warning"><h1 id="dgDMVal">0</h1><span>DM</span></div>
  <div class="card card-slate"><h1 id="dgODGJVal">0</h1><span>ODGJ</span></div>
  <div class="card card-danger"><h1 id="dgKankerVal">0</h1><span>Kanker</span></div>
</div>

<!-- ================= PKPR ================= -->
<div class="aggregate-title">
  <h3>PKPR</h3>
</div>
<div class="row">
  <div class="card card-primary"><h1 id="pkprTotalVal">0</h1><span>Total PKPR</span></div>
  <div class="card card-info"><h1 id="pkprLakiVal">0</h1><span>Laki-laki</span></div>
  <div class="card card-purple"><h1 id="pkprPerempuanVal">0</h1><span>Perempuan</span></div>
</div>

<!-- ================= Disabilitas ================= -->
<div class="aggregate-title">
  <h3>DISABILITAS</h3>
</div>
<div class="row">
  <div class="card dark"><h1 id="disabilitasVal">0</h1><span>Disabilitas</span></div>
</div>

<!-- ================= LANSIA ================= -->
<div class="aggregate-title">
  <h3>LANSIA</h3>
</div>
<div class="row">
  <div class="card card-success"><h1 id="lMandiriVal">0</h1><span>Mandiri</span></div>
  <div class="card card-warning"><h1 id="lBSedangVal">0</h1><span>Kategori B Sedang</span></div>
  <div class="card card-muted"><h1 id="lBRinganVal">0</h1><span>Kategori B Ringan</span></div>
  <div class="card card-danger"><h1 id="lCVal">0</h1><span>Kategori C</span></div>
</div>
<div class="separator"></div>

<!-- ================= SANITASI TPP ================= -->
<div class="aggregate-title">
  <h3>SANITASI</h3>
</div>
<div class="row">
<div class="card card-teal"><h1 id="tppJasaBoga">0</h1><span>Jasa Boga</span></div>
<div class="card card-primary"><h1 id="tppRestoran">0</h1><span>Restoran</span></div>
<div class="card card-slate"><h1 id="tppHomeIndustri">0</h1><span>Home Industri</span></div>
<div class="card card-info"><h1 id="tppDamiu">0</h1><span>DAMIU</span></div>
<div class="card card-success"><h1 id="tppRumahMakan">0</h1><span>Rumah Makan</span></div>
<div class="card card-warning"><h1 id="tppGeraiJajanan">0</h1><span>Gerai Jajanan</span></div>
<div class="card card-danger"><h1 id="tppGeraiKeliling">0</h1><span>Gerai Keliling</span></div>
<div class="card card-info"><h1 id="tppDapurGerai">0</h1><span>Dapur Gerai</span></div>
<div class="card card-primary"><h1 id="tppSentraKantin">0</h1><span>Sentra / Kantin</span></div>
</div>

<!-- ================= SANITASI JAMBAN SEHAT (KK) ================= -->
<div class="row">
<div class="card card-success"><h1 id="jambanSepticAman">0</h1><span>Septic Tank Aman</span></div>
<div class="card card-warning"><h1 id="jambanKomunal">0</h1><span>Septic Komunal</span></div>
<div class="card card-danger"><h1 id="jambanBelum">0</h1><span>Belum Septic Tank</span></div>
</div>

<!-- ================= SANITASI AKSES AIR BERSIH ================= -->
<div class="row">
<div class="card card-info"><h1 id="airSumurBor">0</h1><span>Sumur Bor</span></div>
<div class="card card-primary"><h1 id="airPDAM">0</h1><span>Ledeng / PDAM</span></div>
<div class="card card-teal"><h1 id="airArtesis">0</h1><span>Artesis</span></div>
</div>

<!-- ================= SANITASI AKSES AIR MINUM ================= -->
<div class="row">
<div class="card card-primary"><h1 id="airMinumAMK">0</h1><span>AMK</span></div>
<div class="card card-info"><h1 id="airMinumIsiUlang">0</h1><span>Air Isi Ulang</span></div>
<div class="card card-teal"><h1 id="airMinumMasak">0</h1><span>Air Dimasak</span></div>
</div>
<div class="separator"></div>

<!-- ================= GRAFIK ================= -->
<div class="row">
<div class="white"><b>Ibu Hamil</b><div class="chart-box"><canvas id="chartIbu"></canvas></div></div>
<div class="white"><b>Balita</b><div class="chart-box"><canvas id="chartBalita"></canvas></div></div>
</div>

<div class="row">
<div class="white"><b>TB</b><div class="chart-box"><canvas id="chartTB"></canvas></div></div>
<div class="white"><b>Disabilitas</b><div class="chart-box"><canvas id="chartDisabilitas"></canvas></div></div>
</div>

<div class="row">
<div class="white"><b>10 Besar DIagnosa</b><div class="chart-box"><canvas id="chartdiagnosaTop10"></canvas></div></div>
<div class="white"><b>Lansia</b><div class="chart-box"><canvas id="chartLansia"></canvas></div></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { collection, getDocs, query, where }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* ================= GLOBAL CHART ================= */
let cIbu,cBalita,cTB,cDisabilitas,cLansia,cDiagTop10;

/* ================= ELEMENT CHART (WAJIB) ================= */
const chartIbu = document.getElementById("chartIbu");
const chartBalita = document.getElementById("chartBalita");
const chartTB = document.getElementById("chartTB");
const chartDisabilitas = document.getElementById("chartDisabilitas");
const chartLansia = document.getElementById("chartLansia");
  
/* ================= FILTER ================= */
const rwInput=document.getElementById("rwInput");
const bulanInput=document.getElementById("bulanInput");
const btnTampil=document.getElementById("btnTampil");

bulanInput.value=new Date().toISOString().slice(0,7);
for(let i=1;i<=16;i++){
  const o=document.createElement("option");
  o.value=`RW.${i}`;
  o.textContent=`RW ${i}`;
  rwInput.appendChild(o);
}
btnTampil.onclick=loadAll;

/* ================= DATA WILAYAH ================= */
async function loadProfilWilayah(){
  const q = rwInput.value
    ? query(collection(db,"profil_puskesmas"),
        where("bulanLapor","==",bulanInput.value),
        where("rw","==",rwInput.value))
    : query(collection(db,"profil_puskesmas"),
        where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);

  const t={rt:0,penduduk:0,jkn:0,mbg:0,tk:0,sd:0,smp:0,sma:0,ibadah:0,ponpes:0,hotel:0,kantor:0};

  snap.forEach(d=>{
    const x=d.data();
    t.rt+=x.jumlahRT||0;
    t.penduduk+=x.jumlahPenduduk||0;
    t.jkn+=x.jumlahJKN||0;
    t.mbg+=x.jumlahMBG||0;
    t.tk+=x.sekolahTK||0;
    t.sd+=x.sekolahSD||0;
    t.smp+=x.sekolahSMP||0;
    t.sma+=x.sekolahSMA||0;
    t.ibadah+=x.tempatIbadah||0;
    t.ponpes+=x.pondokPesantren||0;
    t.hotel+=x.hotel||0;
    t.kantor+=x.perkantoran||0;
  });

  Object.keys(t).forEach(k=>{
    const el=document.getElementById(k+"Val");
    if(el) el.innerText=t[k];
  });
}

/* ================= DATA KESEHATAN ================= */
async function loadKesehatan(){
  const q = rwInput.value
    ? query(collection(db,"kesehatan_agregat"),
        where("bulanLapor","==",bulanInput.value),
        where("rw","==",rwInput.value))
    : query(collection(db,"kesehatan_agregat"),
        where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);

  const t={
    ihNormal:0, ihRisti:0, ihKek:0,
    inNormal:0, inRisti:0,
    bayiTotal:0,
    bNormal:0, bStunting:0, bGizi:0, bPMT:0,
    tbPengobatan:0, tbSelesai:0,
    dgHT:0, dgDM:0, dgODGJ:0, dgKanker:0,
    pkprTotal:0, pkprLaki:0, pkprPerempuan:0,
    disabilitas:0,
    lMandiri:0, lBSedang:0, lBRingan:0, lC:0
  };

  snap.forEach(d=>{
    const x=d.data();

    t.ihNormal += x.ihNormal || 0;
    t.ihRisti  += x.ihRisti || 0;
    t.ihKek    += x.ihKEK || x.ihKek || 0;

    t.inNormal += x.inNormal || 0;
    t.inRisti  += x.inRisti || 0;

    t.bayiTotal += x.bayiTotal || x.bayi || 0;

    t.bNormal   += x.bNormal || 0;
    t.bStunting += x.bStunting || 0;
    t.bGizi     += x.bGizi || x.bGiziBuruk || 0;
    t.bPMT      += x.bPMT || 0;

    t.tbPengobatan += x.tbPengobatan || 0;
    t.tbSelesai    += x.tbSelesai || 0;

    t.dgHT     += x.dgHT || 0;
    t.dgDM     += x.dgDM || 0;
    t.dgODGJ   += x.dgODGJ || 0;
    t.dgKanker += x.dgKanker || 0;

    t.pkprTotal      += x.pkprTotal || 0;
    t.pkprLaki       += x.pkprLaki || x.pkprL || 0;
    t.pkprPerempuan  += x.pkprPerempuan || x.pkprP || 0;

    t.disabilitas += x.disabilitas || x.jumlahDisabilitas || 0;

    t.lMandiri += x.lMandiri || 0;
    t.lBSedang += x.lBSedang || 0;
    t.lBRingan += x.lBRingan || 0;
    t.lC       += x.lC || 0;
  });

  console.table(t);
  Object.keys(t).forEach(k=>{
    const el=document.getElementById(k+"Val");
    if(el) el.innerText=t[k];
  });

  [cIbu,cBalita,cTB,cDisabilitas,cLansia].forEach(c=>c&&c.destroy());

  if(chartIbu) cIbu=new Chart(chartIbu,{type:"pie",
    data:{labels:["Normal","Risti","KEK"],datasets:[{data:[t.ihNormal,t.ihRisti,t.ihKek]}]}
  });

  if(chartBalita) cBalita=new Chart(chartBalita,{type:"pie",
    data:{labels:["Normal","Stunting","Gizi Buruk","PMT"],datasets:[{data:[t.bNormal,t.bStunting,t.bGizi,t.bPMT]}]}
  });

  if(chartTB) cTB=new Chart(chartTB,{type:"bar",
    data:{labels:["Pengobatan","Selesai"],datasets:[{data:[t.tbPengobatan,t.tbSelesai]}]}
  });

  if(chartDisabilitas) cDisabilitas=new Chart(chartDisabilitas,{type:"bar",
    data:{labels:["Disabilitas"],datasets:[{data:[t.disabilitas]}]}
  });

  /* ================= LANSIA ================= */
  lMandiriVal.innerText = t.lMandiri;
  lBSedangVal.innerText = t.lBSedang;
  lBRinganVal.innerText = t.lBRingan;
  lCVal.innerText       = t.lC;
  
  if(cLansia) cLansia.destroy();
  
  cLansia = new Chart(chartLansia,{
      type:"pie",
      data:{
        labels:["Mandiri","B Sedang","B Ringan","C"],
        datasets:[{
          data:[
            t.lMandiri,
            t.lBSedang,
            t.lBRingan,
            t.lC
          ]
        }]
      }
    });
  
  }
 }

/* ================= SANITASI ================= */
async function loadSanitasi(){
  const q = rwInput.value
    ? query(collection(db,"sanitasi_agregat"),
        where("bulanLapor","==",bulanInput.value),
        where("rw","==",rwInput.value))
    : query(collection(db,"sanitasi_agregat"),
        where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);

  const t={
    tppJasaBoga:0,tppRestoran:0,tppHomeIndustri:0,tppDamiu:0,
    tppRumahMakan:0,tppGeraiJajanan:0,tppGeraiKeliling:0,
    tppDapurGerai:0,tppSentraKantin:0,
    jambanSepticAman:0,jambanKomunal:0,jambanBelum:0,
    airSumurBor:0,airPDAM:0,airArtesis:0,
    airMinumAMK:0,airMinumIsiUlang:0,airMinumMasak:0
  };

  snap.forEach(d=>{
    const x=d.data();
    t.tppJasaBoga      += x.tppJasaBoga || x.jasaBoga || 0;
    t.tppRestoran     += x.tppRestoran || x.restoran || 0;
    t.tppHomeIndustri += x.tppHomeIndustri || x.homeIndustri || 0;
    t.tppDamiu        += x.tppDamiu || x.damiu || 0;
    t.tppRumahMakan   += x.tppRumahMakan || x.rumahMakan || 0;
    t.tppGeraiJajanan += x.tppGeraiJajanan || x.geraiJajanan || 0;
    t.tppGeraiKeliling+= x.tppGeraiKeliling || x.geraiKeliling || 0;
    t.tppDapurGerai   += x.tppDapurGerai || x.dapurGerai || 0;
    t.tppSentraKantin += x.tppSentraKantin || x.sentraKantin || 0;

    t.jambanSepticAman+= x.jambanSepticAman || x.septicAman || 0;
    t.jambanKomunal   += x.jambanKomunal || x.septicKomunal || 0;
    t.jambanBelum     += x.jambanBelum || x.belumSeptic || 0;

    t.airSumurBor     += x.airSumurBor || x.sumurBor || 0;
    t.airPDAM         += x.airPDAM || x.pdam || 0;
    t.airArtesis      += x.airArtesis || x.artesis || 0;

    t.airMinumAMK     += x.airMinumAMK || x.amk || 0;
    t.airMinumIsiUlang+= x.airMinumIsiUlang || x.isiUlang || 0;
    t.airMinumMasak   += x.airMinumMasak || x.dimasak || 0;
  });

  Object.keys(t).forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.innerText=t[id];
  });
}

/* ================= DIAGNOSA TOP 10 (FINAL) ================= */
async function loadDiagnosaTop10(){
  const snap = await getDoc(
    doc(db,"diagnosa_bulanan", bulanInput.value)
  );
  if(!snap.exists()) return;

  const data = snap.data();
  if(!Array.isArray(data.diagnosaTop10)) return;

  cDiagTop10 && cDiagTop10.destroy();
  cDiagTop10 = new Chart(chartdiagnosaTop10,{
    type:"bar",
    data:{
      labels: data.diagnosaTop10.map(i=>i.nama),
      datasets:[{
        label:"Jumlah Kasus",
        data: data.diagnosaTop10.map(i=>i.jumlah)
      }]
    }
  });
}

/* ================= LOAD ALL ================= */
async function loadAll(){
  await loadProfilWilayah();
  await loadKesehatan();
  await loadSanitasi();
  await loadDiagnosaTop10();
}
loadAll();
</script>

</body>
</html>
