<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Input Data Wilayah & Diagnosa</title>

<style>
:root{
  --primary:#3b5bdb;
  --bg:#f4f6f9;
  --card:#ffffff;
  --text:#212529;
  --muted:#6c757d;
}
*{box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  background:var(--bg);
  padding:24px;
  color:var(--text);
}
.container{max-width:1100px;margin:auto}
.header{margin-bottom:24px}
.header h2{margin:0;font-size:24px}
.header p{margin:6px 0 0;color:var(--muted)}

.card{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
  margin-bottom:16px;
}
.card h3{
  margin:0 0 12px;
  font-size:16px;
  border-left:4px solid var(--primary);
  padding-left:8px;
}

.row{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}

label{font-size:12px;color:var(--muted)}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #dee2e6;
  font-size:14px;
}

/* ===== DIAGNOSA KIRI - KANAN ===== */
.diagnosa-list{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.diagnosa-row{
  display:grid;
  grid-template-columns:3fr 1.2fr;
  gap:14px;
}
@media(max-width:600px){
  .diagnosa-row{grid-template-columns:1fr}
}

.footer{
  display:flex;
  justify-content:flex-end;
  margin-top:16px;
}
.btn{
  padding:12px 24px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:10px;
  font-size:15px;
  cursor:pointer;
}
.btn:disabled{
  opacity:.6;
  cursor:not-allowed;
}
</style>
</head>

<body>
<div class="container">

<!-- HEADER -->
<div class="header">
  <h2>Input Data Agregat Puskesmas</h2>
  <p>Data Wilayah & Diagnosa Penyakit (Per RW & Bulan)</p>
</div>

<!-- ================= DATA WILAYAH ================= -->
<div class="card">
  <h3>Data Wilayah & Kepesertaan</h3>

  <div class="row">
    <div>
      <label>Bulan Laporan</label>
      <input type="month" id="bulanWilayah">
    </div>
    <div>
      <label>RW</label>
      <select id="rwWilayah">
        <option value="">Pilih RW</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div><label>Jumlah RT</label><input id="jmlRT" type="number"></div>
    <div><label>Jumlah Penduduk</label><input id="jmlPenduduk" type="number"></div>
    <div><label>Jumlah Peserta JKN</label><input id="jmlJKN" type="number"></div>

    <div><label>Sekolah TK / PAUD</label><input id="jmlTK" type="number"></div>
    <div><label>Sekolah SD</label><input id="jmlSD" type="number"></div>
    <div><label>Sekolah SMP</label><input id="jmlSMP" type="number"></div>
    <div><label>Sekolah SMA / SMK</label><input id="jmlSMA" type="number"></div>

    <div><label>Dapur MBG</label><input id="jmlMBG" type="number"></div>
    <div><label>Tempat Ibadah</label><input id="jmlIbadah" type="number"></div>
    <div><label>Pondok Pesantren</label><input id="jmlPonpes" type="number"></div>
    <div><label>Hotel</label><input id="jmlHotel" type="number"></div>
    <div><label>Perkantoran</label><input id="jmlKantor" type="number"></div>
    <div><label>Salon</label><input id="jmlSalon" type="number"></div>
    <div><label>Villa</label><input id="jmlVilla" type="number"></div>
    <div><label>Tempat Olahraga</label><input id="jmlOlahraga" type="number"></div>
    <div><label>Jejaring</label><input id="jmlJejaring" type="number"></div>
  </div>
</div>

<div class="footer">
  <button id="btnSimpanWilayah" class="btn">
    ðŸ’¾ Simpan Data Wilayah
  </button>
</div>

<!-- ================= DIAGNOSA ================= -->
<div class="card">
  <h3>Diagnosa Penyakit (Top 10)</h3>
  <div class="diagnosa-list">

  <div class="row">
    <div>
      <label>Bulan Diagnosa</label>
      <input type="month" id="bulanDiagnosa">
    </div>
</div>
    
    <!-- LOOP 1â€“10 -->
    <script>
      for(let i=1;i<=10;i++){
        document.write(`
        <div class="diagnosa-row">
          <div>
            <label>Nama Diagnosa ${i}</label>
            <input id="diagNama${i}" type="text">
          </div>
          <div>
            <label>Jumlah</label>
            <input id="diagJumlah${i}" type="number">
          </div>
        </div>
        `);
      }
    </script>

  </div>
</div>

<div class="footer">
  <button id="btnSimpanDiagnosa" class="btn" style="margin-left:10px">
    ðŸ’¾ Simpan Diagnosa Bulanan
  </button>
</div>

</div>

<!-- ================= SCRIPT FIREBASE ================= -->
<script type="module">
import { db } from "./firebase.js";
import { doc, setDoc, serverTimestamp }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

/* INIT RW */
const rwWilayah=document.getElementById("rwWilayah");
for(let i=1;i<=16;i++){
  const o=document.createElement("option");
  o.value=`RW.${i}`;
  o.textContent=`RW ${i}`;
  rwWilayah.appendChild(o);
}

/* ================= DEFAULT BULAN ================= */
const bulanWilayah  = document.getElementById("bulanWilayah");
const bulanDiagnosa = document.getElementById("bulanDiagnosa");

const bulanSekarang = new Date().toISOString().slice(0,7);

/* set nilai awal */
bulanWilayah.value  = bulanSekarang;
bulanDiagnosa.value = bulanSekarang;

/* sinkron (opsional UX) */
bulanWilayah.addEventListener("change", () => {
  if (!bulanDiagnosa.value) {
    bulanDiagnosa.value = bulanWilayah.value;
  }
});

/* INPUT */
const get=id=>document.getElementById(id);

/* SIMPAN DATA WILAYAH */
document.getElementById("btnSimpanWilayah").onclick = async () => {
  try {
    if (!rwWilayah.value || !bulanWilayah.value) {
      alert("Bulan & RW wajib diisi");
      return;
    }

    const id = `${bulanWilayah.value}_${rwWilayah.value}`;

    await setDoc(doc(db,"profil_puskesmas",id),{
      bulanLapor: bulanWilayah.value,
      rw: rwWilayah.value,

      jumlahRT:+get("jmlRT").value||0,
      jumlahPenduduk:+get("jmlPenduduk").value||0,
      jumlahJKN:+get("jmlJKN").value||0,

      sekolahTK:+get("jmlTK").value||0,
      sekolahSD:+get("jmlSD").value||0,
      sekolahSMP:+get("jmlSMP").value||0,
      sekolahSMA:+get("jmlSMA").value||0,

      jumlahMBG:+get("jmlMBG").value||0,
      tempatIbadah:+get("jmlIbadah").value||0,
      pondokPesantren:+get("jmlPonpes").value||0,
      hotel:+get("jmlHotel").value||0,
      perkantoran:+get("jmlKantor").value||0,
      salon:+get("jmlSalon").value||0,
      villa:+get("jmlVilla").value||0,
      tempatOlahraga:+get("jmlOlahraga").value||0,
      jejaring:+get("jmlJejaring").value||0,

      updatedAt: serverTimestamp()
    }, { merge:true });

    alert("âœ… Data wilayah berhasil disimpan");

    // ðŸ”„ reload aman
    setTimeout(() => {
      location.reload();
    }, 300);

  } catch (err) {
    console.error(err);
    alert("âŒ Gagal menyimpan data");
  }
};

  // ================= SIMPAN DIAGNOSA BULANAN =================
  document.getElementById("btnSimpanDiagnosa").onclick = async () => {
    const bulan = document.getElementById("bulanDiagnosa").value;
    if(!bulan){
      alert("Bulan diagnosa wajib diisi");
      return;
    }
  
    const diagnosa=[];
    for(let i=1;i<=10;i++){
      const nama=get(`diagNama${i}`).value.trim();
      const jumlah=+get(`diagJumlah${i}`).value||0;
      if(nama){
        diagnosa.push({urutan:i,nama,jumlah});
      }
    }
  
    if(!diagnosa.length){
      alert("Isi minimal 1 diagnosa");
      return;
    }
  
    await setDoc(
      doc(db,"diagnosa_bulanan",bulan),
      {
        bulanLapor: bulan,
        diagnosaTop10: diagnosa,
        updatedAt: serverTimestamp()
      },
      {merge:true}
    );

        // âœ… RESET INPUT DIAGNOSA
    for(let i=1;i<=10;i++){
      get(`diagNama${i}`).value = "";
      get(`diagJumlah${i}`).value = "";
    }
  
    alert("âœ… Diagnosa bulanan berhasil disimpan");
  };
</script>

</body>
</html>
