<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Data Kesehatan</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;padding:20px}
.row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.card{flex:1;padding:16px;border-radius:10px;color:#fff;min-width:200px}
.blue{background:#3b5bdb}.green{background:#2f9e44}
.orange{background:#f59f00}.teal{background:#0ca678}
.purple{background:#7048e8}.dark{background:#343a40}.gray{background:#495057}

.white{background:#fff;padding:16px;border-radius:10px;flex:1;min-width:300px}

.chart-box{position:relative;width:100%;height:300px}

input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc}
button{background:#3b5bdb;color:#fff;border:none;cursor:pointer}
</style>
</head>

<body>

<h2>Dashboard Data Kesehatan</h2>

<!-- ================= DATA WILAYAH ================= -->
<div class="row">
  <div class="card green">
    <h1 id="jmlRT">0</h1>
    Jumlah RT
  </div>
  <div class="card blue">
    <h1 id="jmlPenduduk">0</h1>
    Jumlah Penduduk
  </div>
  <div class="card teal">
    <h1 id="jmlJKN">0</h1>
    Peserta JKN
  </div>
  <div class="card orange">
    <h1 id="jmlFLS">0</h1>
    Fasilitas LS
  </div>
</div>

<!-- ================= FILTER (IDENTITAS LAPORAN) ================= -->
<div class="row">
  <div class="white">
    <b>Filter Laporan</b><br><br>
    <input type="month" id="bulanInput">
    <select id="rwInput">
      <option value="">SEMUA RW</option>
    </select>
    <button id="btnTampil">Tampilkan</button>
    <button id="btnExport">Export PDF</button>
  </div>
</div>

<!-- ================= CARD KESEHATAN ================= -->
<div class="row">
  <div class="card purple"><h1 id="jmlIbuHamil">0</h1>Ibu Hamil</div>
  <div class="card blue"><h1 id="jmlBalita">0</h1>Balita</div>
  <div class="card dark"><h1 id="jmlTB">0</h1>TB</div>
  <div class="card gray"><h1 id="jmlDis">0</h1>Disabilitas</div>
</div>

<!-- ================= GRAFIK ================= -->
<div class="row">
  <div class="white">
    <h3>Ibu Hamil</h3>
    <div class="chart-box"><canvas id="chartIbu"></canvas></div>
  </div>
  <div class="white">
    <h3>Balita</h3>
    <div class="chart-box"><canvas id="chartBalita"></canvas></div>
  </div>
</div>

<div class="row">
  <div class="white">
    <h3>TB</h3>
    <div class="chart-box"><canvas id="chartTB"></canvas></div>
  </div>
  <div class="white">
    <h3>Disabilitas</h3>
    <div class="chart-box"><canvas id="chartDis"></canvas></div>
  </div>
</div>

<div class="row">
  <div class="white">
    <h3>Perbandingan RW</h3>
    <div class="chart-box"><canvas id="chartRW"></canvas></div>
  </div>
</div>

<div class="row">
  <div class="white">
    <h3>Tren Januari â€“ Desember</h3>
    <div class="chart-box"><canvas id="chartTrend"></canvas></div>
  </div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { collection, query, where, getDocs }
from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

let chartIbu, chartBalita, chartTB, chartDis, chartRW, chartTrend;

const bulanInput=document.getElementById("bulanInput");
const rwInput=document.getElementById("rwInput");
bulanInput.value=new Date().toISOString().slice(0,7);

// RW dropdown
for(let i=1;i<=16;i++){
  const o=document.createElement("option");
  o.value=`RW.${String(i).padStart(2,"0")}`;
  o.textContent=o.value;
  rwInput.appendChild(o);
}

btnTampil.onclick=()=>{ loadWilayah(); loadDashboard(); };

// ================= LOAD DATA WILAYAH =================
async function loadWilayah(){
  let q = rwInput.value
    ? query(collection(db,"wilayah_agregat"),
        where("bulanLapor","==",bulanInput.value),
        where("rw","==",rwInput.value))
    : query(collection(db,"wilayah_agregat"),
        where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);
  let rt=0,pdd=0,jkn=0,fls=0;

  snap.forEach(d=>{
    const x=d.data();
    rt+=x.jumlahRT||0;
    pdd+=x.jumlahPenduduk||0;
    jkn+=x.jumlahJKN||0;
    fls+=x.fasilitasLS||0;
  });

  jmlRT.innerText=rt;
  jmlPenduduk.innerText=pdd;
  jmlJKN.innerText=jkn;
  jmlFLS.innerText=fls;
}

// ================= LOAD DATA KESEHATAN =================
async function loadDashboard(){
  let q = rwInput.value
    ? query(collection(db,"kesehatan_agregat"),
        where("bulanLapor","==",bulanInput.value),
        where("rw","==",rwInput.value))
    : query(collection(db,"kesehatan_agregat"),
        where("bulanLapor","==",bulanInput.value));

  const snap=await getDocs(q);
  if(snap.empty) return;

  let t={ih:0,bal:0,tb:0,dis:0};
  let rwMap={};

  snap.forEach(d=>{
    const x=d.data();
    t.ih+=x.ibuHamilNormal+x.ibuHamilRisti;
    t.bal+=x.balitaNormal+x.balitaStunting+x.balitaGiziBuruk;
    t.tb+=x.tbTotal;
    t.dis+=x.disabilitas;

    if(!rwMap[x.rw]) rwMap[x.rw]=0;
    rwMap[x.rw]+=t.ih+t.bal;
  });

  jmlIbuHamil.innerText=t.ih;
  jmlBalita.innerText=t.bal;
  jmlTB.innerText=t.tb;
  jmlDis.innerText=t.dis;

  if(chartRW) chartRW.destroy();
  chartRW=new Chart(chartRWEl,{
    type:"bar",
    options:{responsive:true,maintainAspectRatio:false},
    data:{labels:Object.keys(rwMap),datasets:[{label:"Total Kasus",data:Object.values(rwMap)}]}
  });
}

loadWilayah();
loadDashboard();
</script>

</body>
</html>
