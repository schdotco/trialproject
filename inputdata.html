<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Input Data Kesehatan</title>

  <style>
    body {
      font-family: Arial;
      background: #f4f6f9;
      padding: 20px;
    }
    h2 { margin-bottom: 10px; }
    h3 { margin-top: 20px; }

    .card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    input, select {
      padding: 8px;
      width: 100%;
      max-width: 220px;
    }

    .btn {
      padding: 10px 18px;
      background: #3b5bdb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      background: #364fc7;
    }
  </style>
</head>
<body>

<h2>Input Data Agregat Kesehatan</h2>

<!-- IDENTITAS LAPORAN -->
<div class="card">
  <h3>Identitas Laporan</h3>
  <div class="row">
    <input type="month" id="bulanLapor">
    <select id="rw">
      <option value="">Pilih RW</option>
    </select>
  </div>
</div>

<!-- IBU HAMIL -->
<div class="card">
  <h3>Ibu Hamil</h3>
  <div class="row">
    <input id="ihNormal" type="number" placeholder="Normal">
    <input id="ihRisti" type="number" placeholder="Risiko Tinggi">
  </div>
</div>

<!-- BALITA -->
<div class="card">
  <h3>Balita</h3>
  <div class="row">
    <input id="bNormal" type="number" placeholder="Normal">
    <input id="bStunting" type="number" placeholder="Stunting">
    <input id="bGizi" type="number" placeholder="Gizi Buruk">
  </div>
</div>

<!-- LAINNYA -->
<div class="card">
  <h3>Lainnya</h3>
  <div class="row">
    <input id="disabilitas" type="number" placeholder="Disabilitas">
    <input id="tbPengobatan" type="number" placeholder="TB Dalam Pengobatan">
    <input id="tbTotal" type="number" placeholder="Jumlah TB Terdeteksi">
  </div>
</div>

<!-- LANSIA -->
<div class="card">
  <h3>Lansia</h3>
  <div class="row">
    <input id="lMandiri" type="number" placeholder="Mandiri">
    <input id="lB" type="number" placeholder="Kategori B">
    <input id="lC" type="number" placeholder="Kategori C">
  </div>
</div>

<!-- SANITASI -->
<div class="card">
  <h3>Sanitasi</h3>
  <input id="odf" type="number" placeholder="ODF (0 / 1)">
</div>

<button id="btnSimpan" class="btn">Simpan / Update Data</button>

<!-- SCRIPT -->
<script type="module">
  import { db } from "./firebase.js";
  import {
    doc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  // default bulan sekarang
  const bulanInput = document.getElementById("bulanLapor");
  bulanInput.value = new Date().toISOString().slice(0, 7);

  // generate dropdown RW.01 – RW.16
  const rwSelect = document.getElementById("rw");
  for (let i = 1; i <= 16; i++) {
    const opt = document.createElement("option");
    opt.value = `RW.${String(i).padStart(2, "0")}`;
    opt.textContent = opt.value;
    rwSelect.appendChild(opt);
  }

  document.getElementById("btnSimpan").addEventListener("click", async () => {
    try {
      if (!bulanInput.value || !rwSelect.value) {
        alert("❌ Bulan & RW wajib diisi");
        return;
      }

      // document ID = BULAN + RW → UPDATE / REPLACE
      const docId = `${bulanInput.value}_${rwSelect.value}`;

      await setDoc(doc(db, "kesehatan_agregat", docId), {
        bulanLapor: bulanInput.value,
        rw: rwSelect.value,

        ibuHamilNormal: Number(ihNormal.value) || 0,
        ibuHamilRisti: Number(ihRisti.value) || 0,

        balitaNormal: Number(bNormal.value) || 0,
        balitaStunting: Number(bStunting.value) || 0,
        balitaGiziBuruk: Number(bGizi.value) || 0,

        disabilitas: Number(disabilitas.value) || 0,

        tbPengobatan: Number(tbPengobatan.value) || 0,
        tbTotal: Number(tbTotal.value) || 0,

        lansiaMandiri: Number(lMandiri.value) || 0,
        lansiaB: Number(lB.value) || 0,
        lansiaC: Number(lC.value) || 0,

        odf: Number(odf.value) || 0,

        updatedAt: serverTimestamp()
      });

      alert("✅ Data berhasil diperbarui");
      window.location.href = "dashboard.html";

    } catch (err) {
      console.error(err);
      alert("❌ Gagal menyimpan data");
    }
  });
</script>

</body>
</html>
